name: CI Data Pipeline
run-name: ${{ github.actor }} pushed to ${{ github.ref }}

on:
  push:
    branches: ["develop", "main"]
    paths:
      - "projects/data-pipeline/**"
  pull_request:
    branches: ["develop", "main"]
    paths:
      - "projects/data-pipeline/**"

jobs:
  data-pipeline-ci:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Setup environment
        run: |
          make install-poetry
          # Source bashrc to sync poetry links
          source ~/.bashrc
          echo "Poetry version is $(poetry --version)" 

      - name: Validate the dependencies and lock file
        needs: Setup environment
        working-directory: ./projects/data-pipeline
        run: poetry lock --check

      - name: API - Install python dependencies
        needs: Validate the dependencies and lock file
        working-directory: ./projects/data-pipeline
        run: make install-deps

      - name: API - Check formatting
        needs: API - Install python dependencies
        working-directory: ./projects/data-pipeline
        run: make check

      - name: API - Run tests
        needs: API - Install python dependencies
        working-directory: ./projects/data-pipeline
        run: make test